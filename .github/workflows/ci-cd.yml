name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  DOCKER_IMAGE: sakshisanghvi11/todo-app
  DOCKER_TAG: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  test-deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Start Application
        run: |
          docker-compose up -d
          sleep 10  # Give the application time to start

      - name: Check Application Status and Logs
        run: |
          echo "Docker Containers Status:"
          docker ps -a
          echo "-----------------------------------"
          echo "Application Logs:"
          docker logs todo-app
          echo "-----------------------------------"
          echo "Container File System:"
          docker exec todo-app ls -la /app
          echo "-----------------------------------"
          echo "Database Directory:"
          docker exec todo-app ls -la /app/data || echo "Data directory not found"

      - name: Install Testing Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl python3-pip
          pip3 install beautifulsoup4 requests

      - name: Test Application
        run: |
          cat > test_app.py << 'EOL'
          import requests
          from bs4 import BeautifulSoup
          import time
          import sys

          BASE_URL = 'http://localhost:5001'

          def test_app():
              # Test 1: Check if the application is up
              try:
                  response = requests.get(BASE_URL)
                  response.raise_for_status()
                  print("✓ Application is up and running")
              except requests.exceptions.RequestException as e:
                  print("✗ Application is not responding:", str(e))
                  # Get the application logs
                  import subprocess
                  print("\nApplication Logs:")
                  subprocess.run(['docker', 'logs', 'todo-app'])
                  sys.exit(1)

              # Test 2: Add a new task
              try:
                  response = requests.post(f"{BASE_URL}/add", 
                      data={
                          'title': 'Test Todo',
                          'description': 'Testing the application'
                      },
                      allow_redirects=True
                  )
                  response.raise_for_status()
                  print("✓ Successfully added new task")
              except Exception as e:
                  print("✗ Failed to add task:", str(e))
                  sys.exit(1)

              # Test 3: Verify task was added
              try:
                  response = requests.get(BASE_URL)
                  soup = BeautifulSoup(response.text, 'html.parser')
                  if 'Test Todo' in response.text:
                      print("✓ Task found in the list")
                  else:
                      print("✗ Task not found in the list")
                      sys.exit(1)
              except Exception as e:
                  print("✗ Failed to verify task:", str(e))
                  sys.exit(1)

              print("All tests passed successfully!")

          if __name__ == '__main__':
              # Wait a bit for the application to be fully ready
              time.sleep(5)
              test_app()
          EOL

          python3 test_app.py

      - name: Cleanup
        if: always()
        run: |
          docker-compose down
          docker system prune -f
